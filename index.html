<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예산 관리 앱</title>
    <!-- CDN 라이브러리 로딩 순서 수정 및 프로덕션 버전 사용 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b'
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
            PieChart, Pie, Cell, LineChart, Line 
        } = Recharts;
        
        const LucideIcons = window.LucideReact || {};
        const { 
            Plus = () => React.createElement('span', null, '+'),
            Trash2 = () => React.createElement('span', null, '🗑️'),
            Calendar = () => React.createElement('span', null, '📅'),
            TrendingUp = () => React.createElement('span', null, '📈'),
            Target = () => React.createElement('span', null, '🎯'),
            BarChart3 = () => React.createElement('span', null, '📊'),
            PieChart: PieChartIcon = () => React.createElement('span', null, '🥧'),
            DollarSign = () => React.createElement('span', null, '💰'),
            CreditCard = () => React.createElement('span', null, '💳'),
            Home = () => React.createElement('span', null, '🏠'),
            Car = () => React.createElement('span', null, '🚗'),
            Utensils = () => React.createElement('span', null, '🍽️'),
            ShoppingBag = () => React.createElement('span', null, '🛍️'),
            Gamepad2 = () => React.createElement('span', null, '🎮'),
            MoreHorizontal = () => React.createElement('span', null, '⋯'
        } = LucideIcons;

        // Constants
        const CATEGORIES = {
            income: ["급여", "부업", "투자", "기타수입"],
            expense: ["식비", "교통", "쇼핑", "문화", "의료", "교육", "주거", "기타"],
        };

        const CURRENCIES = [
            { value: "KRW", label: "₩ 원", symbol: "₩" },
            { value: "USD", label: "$ 달러", symbol: "$" },
            { value: "EUR", label: "€ 유로", symbol: "€" },
            { value: "JPY", label: "¥ 엔", symbol: "¥" },
        ];

        const COLORS = ["#0088FE", "#00C49F", "#FFBB28", "#FF8042", "#8884D8", "#82CA9D", "#FFC658", "#FF7C7C"];

        // Toast Hook
        function useToast() {
            const [toasts, setToasts] = useState([]);

            const toast = useCallback(({ title, description, variant = "default" }) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, title, description, variant }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            }, []);

            return { toast, toasts };
        }

        // UI Components
        function Card({ children, className = "", ...props }) {
            return (
                <div className={`card p-6 ${className}`} {...props}>
                    {children}
                </div>
            );
        }

        function CardHeader({ children, className = "" }) {
            return <div className={`mb-4 ${className}`}>{children}</div>;
        }

        function CardTitle({ children, className = "" }) {
            return <h3 className={`text-lg font-semibold ${className}`}>{children}</h3>;
        }

        function CardContent({ children, className = "" }) {
            return <div className={className}>{children}</div>;
        }

        function Button({ children, variant = "primary", size = "default", className = "", onClick, ...props }) {
            const baseClasses = "btn inline-flex items-center justify-center px-4 py-2 text-sm";
            const variantClasses = {
                primary: "btn-primary",
                secondary: "btn-secondary", 
                outline: "btn-outline",
                ghost: "bg-transparent hover:bg-gray-100 dark:hover:bg-gray-800"
            };
            const sizeClasses = {
                sm: "px-2 py-1 text-xs",
                default: "px-4 py-2 text-sm",
                lg: "px-6 py-3 text-base"
            };

            return (
                <button 
                    className={`${baseClasses} ${variantClasses[variant]} ${sizeClasses[size]} ${className}`}
                    onClick={onClick}
                    {...props}
                >
                    {children}
                </button>
            );
        }

        function Input({ className = "", ...props }) {
            return <input className={`input w-full ${className}`} {...props} />;
        }

        function Label({ children, htmlFor, className = "" }) {
            return <label htmlFor={htmlFor} className={`block text-sm font-medium mb-1 ${className}`}>{children}</label>;
        }

        function Select({ children, value, onValueChange, className = "" }) {
            return (
                <select 
                    className={`input ${className}`}
                    value={value}
                    onChange={(e) => onValueChange(e.target.value)}
                >
                    {children}
                </select>
            );
        }

        function SelectItem({ children, value }) {
            return <option value={value}>{children}</option>;
        }

        function Badge({ children, variant = "secondary", className = "" }) {
            const variantClasses = {
                secondary: "badge-secondary",
                outline: "badge-outline"
            };
            return <span className={`badge ${variantClasses[variant]} ${className}`}>{children}</span>;
        }

        function Progress({ value, className = "" }) {
            return (
                <div className={`progress h-2 ${className}`}>
                    <div className="progress-bar" style={{ width: `${value}%` }}></div>
                </div>
            );
        }

        function Dialog({ children, open, onOpenChange }) {
            if (!open) return null;
            
            return (
                <div className="modal-overlay" onClick={() => onOpenChange(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        {children}
                    </div>
                </div>
            );
        }

        function DialogTrigger({ children, asChild, ...props }) {
            return React.cloneElement(children, props);
        }

        function DialogContent({ children }) {
            return <>{children}</>;
        }

        function DialogHeader({ children }) {
            return <div className="mb-4">{children}</div>;
        }

        function DialogTitle({ children }) {
            return <h2 className="text-xl font-semibold">{children}</h2>;
        }

        function Textarea({ className = "", ...props }) {
            return <textarea className={`input min-h-20 ${className}`} {...props} />;
        }

        function Tabs({ children, value, onValueChange }) {
            return (
                <div>
                    {React.Children.map(children, child => 
                        React.cloneElement(child, { activeTab: value, setActiveTab: onValueChange })
                    )}
                </div>
            );
        }

        function TabsList({ children, activeTab, setActiveTab }) {
            return (
                <div className="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 mb-6 overflow-x-auto">
                    {React.Children.map(children, child => 
                        React.cloneElement(child, { activeTab, setActiveTab })
                    )}
                </div>
            );
        }

        function TabsTrigger({ children, value, activeTab, setActiveTab }) {
            const isActive = activeTab === value;
            return (
                <button
                    className={`flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors whitespace-nowrap ${
                        isActive 
                            ? 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm' 
                            : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100'
                    }`}
                    onClick={() => setActiveTab(value)}
                >
                    {children}
                </button>
            );
        }

        function TabsContent({ children, value, activeTab }) {
            if (activeTab !== value) return null;
            return <div>{children}</div>;
        }

        function Toast({ toasts }) {
            return (
                <>
                    {toasts.map(toast => (
                        <div key={toast.id} className="toast">
                            <div className="font-medium">{toast.title}</div>
                            {toast.description && (
                                <div className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    {toast.description}
                                </div>
                            )}
                        </div>
                    ))}
                </>
            );
        }

        // Transaction List Component
        function TransactionList({ transactions, searchTerm, filterCategory, onEdit, onDelete }) {
            const filteredTransactions = transactions
                .filter((transaction) => {
                    const matchesSearch =
                        transaction.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        transaction.memo?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        transaction.tags.some((tag) => tag.toLowerCase().includes(searchTerm.toLowerCase()));

                    const matchesCategory = filterCategory === "all" || transaction.category === filterCategory;

                    return matchesSearch && matchesCategory;
                })
                .sort((a, b) => new Date(b.datetime).getTime() - new Date(a.datetime).getTime());

            const getCurrencySymbol = (currency) => {
                const symbols = { KRW: "₩", USD: "$", EUR: "€", JPY: "¥" };
                return symbols[currency] || currency;
            };

            const formatDateTime = (datetime) => {
                return new Date(datetime).toLocaleString("ko-KR", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            };

            if (filteredTransactions.length === 0) {
                return (
                    <Card>
                        <CardContent className="py-8 text-center text-gray-500">
                            거래 내역이 없습니다.
                        </CardContent>
                    </Card>
                );
            }

            return (
                <div className="space-y-2">
                    {filteredTransactions.map((transaction) => (
                        <Card key={transaction.id} className="hover:shadow-md transition-shadow">
                            <CardContent className="p-4">
                                <div className="flex items-center justify-between flex-col md:flex-row gap-4">
                                    <div className="flex-1 w-full">
                                        <div className="flex items-center gap-2 mb-1 flex-wrap">
                                            <Badge variant="secondary">{transaction.category}</Badge>
                                            <span className="text-sm text-gray-500">{formatDateTime(transaction.datetime)}</span>
                                            {transaction.currency !== "KRW" && <Badge variant="outline">{transaction.currency}</Badge>}
                                        </div>
                                        <h3 className="font-medium">{transaction.name}</h3>
                                        {transaction.tags.length > 0 && (
                                            <div className="flex gap-1 mt-1 flex-wrap">
                                                {transaction.tags.map((tag) => (
                                                    <Badge key={tag} variant="outline" className="text-xs">
                                                        {tag}
                                                    </Badge>
                                                ))}
                                            </div>
                                        )}
                                        {transaction.memo && <p className="text-sm text-gray-500 mt-1">{transaction.memo}</p>}
                                    </div>
                                    <div className="text-right w-full md:w-auto">
                                        <p className={`text-lg font-semibold ${
                                            transaction.type === "income" ? "text-green-600" : "text-red-600"
                                        }`}>
                                            {transaction.type === "income" ? "+" : "-"}
                                            {getCurrencySymbol(transaction.currency)}
                                            {transaction.amount.toLocaleString()}
                                        </p>
                                        <div className="flex gap-1 mt-1 justify-end">
                                            <Button variant="ghost" size="sm" onClick={() => onEdit(transaction)}>
                                                <Edit className="h-4 w-4" />
                                            </Button>
                                            <Button variant="ghost" size="sm" onClick={() => onDelete(transaction.id)}>
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                        </div>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            );
        }

        // Budget Overview Component
        function BudgetOverview({ budgets }) {
            if (budgets.length === 0) {
                return (
                    <Card>
                        <CardHeader>
                            <CardTitle>예산 현황</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <p className="text-gray-500">설정된 예산이 없습니다.</p>
                        </CardContent>
                    </Card>
                );
            }

            return (
                <Card>
                    <CardHeader>
                        <CardTitle>예산 현황</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        {budgets.slice(0, 5).map((budget) => {
                            const percentage = budget.amount > 0 ? (budget.spent / budget.amount) * 100 : 0;
                            const isOverBudget = percentage > 100;

                            return (
                                <div key={budget.category} className="space-y-2">
                                    <div className="flex justify-between text-sm">
                                        <span className="font-medium">{budget.category}</span>
                                        <span className={isOverBudget ? "text-red-600" : "text-gray-500"}>
                                            ₩{budget.spent.toLocaleString()} / ₩{budget.amount.toLocaleString()}
                                        </span>
                                    </div>
                                    <Progress value={Math.min(percentage, 100)} className={isOverBudget ? "bg-red-100" : ""} />
                                </div>
                            );
                        })}
                    </CardContent>
                </Card>
            );
        }

        // Expense Chart Component
        function ExpenseChart({ transactions }) {
            const expenseByCategory = transactions
                .filter((t) => t.type === "expense")
                .reduce((acc, transaction) => {
                    acc[transaction.category] = (acc[transaction.category] || 0) + transaction.amount;
                    return acc;
                }, {});

            const pieData = Object.entries(expenseByCategory).map(([category, amount]) => ({
                name: category,
                value: amount,
            }));

            const monthlyData = transactions.reduce((acc, transaction) => {
                const month = new Date(transaction.datetime).toISOString().slice(0, 7);
                if (!acc[month]) {
                    acc[month] = { month, income: 0, expense: 0 };
                }
                acc[month][transaction.type] += transaction.amount;
                return acc;
            }, {});

            const barData = Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month));

            return (
                <div className="grid gap-6 grid-cols-1">
                    <Card>
                        <CardHeader>
                            <CardTitle>카테고리별 지출</CardTitle>
                        </CardHeader>
                        <CardContent className="overflow-hidden">
                            {pieData.length > 0 ? (
                                <div className="h-64 w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie
                                                data={pieData}
                                                cx="50%"
                                                cy="50%"
                                                labelLine={false}
                                                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                                outerRadius={60}
                                                fill="#8884d8"
                                                dataKey="value"
                                            >
                                                {pieData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                ))}
                                            </Pie>
                                            <Tooltip />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            ) : (
                                <p className="text-center text-gray-500 py-8">지출 데이터가 없습니다.</p>
                            )}
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>월별 수입/지출</CardTitle>
                        </CardHeader>
                        <CardContent className="overflow-hidden">
                            {barData.length > 0 ? (
                                <div className="h-64 w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={barData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="month" />
                                            <YAxis />
                                            <Tooltip />
                                            <Bar dataKey="income" fill="#22c55e" />
                                            <Bar dataKey="expense" fill="#ef4444" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            ) : (
                                <p className="text-center text-gray-500 py-8">데이터가 없습니다.</p>
                            )}
                        </CardContent>
                    </Card>
                </div>
            );
        }

        // Calendar View Component
        function CalendarView({ transactions }) {
            const [currentDate, setCurrentDate] = useState(new Date());

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = lastDayOfMonth.getDate();

            const previousMonth = () => {
                setCurrentDate(new Date(year, month - 1, 1));
            };

            const nextMonth = () => {
                setCurrentDate(new Date(year, month + 1, 1));
            };

            const getTransactionsForDate = (day) => {
                const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
                return transactions.filter((t) => t.datetime.startsWith(dateStr));
            };

            const days = [];

            // Empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                days.push(<div key={`empty-${i}`} className="h-24 border border-gray-200 dark:border-gray-700"></div>);
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayTransactions = getTransactionsForDate(day);
                const income = dayTransactions.filter((t) => t.type === "income").reduce((sum, t) => sum + t.amount, 0);
                const expense = dayTransactions.filter((t) => t.type === "expense").reduce((sum, t) => sum + t.amount, 0);

                days.push(
                    <div key={day} className="h-24 border border-gray-200 dark:border-gray-700 p-1 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                        <div className="text-sm font-medium mb-1">{day}</div>
                        {dayTransactions.length > 0 && (
                            <div className="space-y-1">
                                {income > 0 && <div className="text-xs text-green-600">+₩{income.toLocaleString()}</div>}
                                {expense > 0 && <div className="text-xs text-red-600">-₩{expense.toLocaleString()}</div>}
                                <div className="text-xs font-medium">{dayTransactions.length}건</div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <Card>
                    <CardHeader>
                        <div className="flex items-center justify-between">
                            <CardTitle>
                                {year}년 {month + 1}월
                            </CardTitle>
                            <div className="flex gap-2">
                                <Button variant="outline" size="sm" onClick={previousMonth}>
                                    <ChevronLeft className="h-4 w-4" />
                                </Button>
                                <Button variant="outline" size="sm" onClick={nextMonth}>
                                    <ChevronRight className="h-4 w-4" />
                                </Button>
                            </div>
                        </div>
                    </CardHeader>
                    <CardContent>
                        <div className="grid grid-cols-7 gap-0 border border-gray-200 dark:border-gray-700 overflow-x-auto">
                            {["일", "월", "화", "수", "목", "금", "토"].map((day) => (
                                <div
                                    key={day}
                                    className="h-8 border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-sm font-medium"
                                >
                                    {day}
                                </div>
                            ))}
                            {days}
                        </div>
                    </CardContent>
                </Card>
            );
        }

        // Savings Goal Component
        function SavingsGoal({ savingsGoal, setSavingsGoal, currentSavings }) {
            const [isDialogOpen, setIsDialogOpen] = useState(false);
            const [formData, setFormData] = useState({
                name: savingsGoal?.name || "",
                target: savingsGoal?.target || 0,
                deadline: savingsGoal?.deadline || "",
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                setSavingsGoal({
                    ...formData,
                    current: currentSavings,
                });
                setIsDialogOpen(false);
            };

            const progress = savingsGoal ? Math.min((currentSavings / savingsGoal.target) * 100, 100) : 0;

            return (
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0">
                        <CardTitle className="flex items-center gap-2">
                            <Target className="h-5 w-5" />
                            저축 목표
                        </CardTitle>
                        <Button variant="outline" size="sm" onClick={() => setIsDialogOpen(true)}>
                            <Edit className="h-4 w-4 mr-2" />
                            {savingsGoal ? "수정" : "설정"}
                        </Button>
                    </CardHeader>
                    <CardContent>
                        {savingsGoal ? (
                            <div className="space-y-4">
                                <div>
                                    <h3 className="font-medium">{savingsGoal.name}</h3>
                                    <p className="text-sm text-gray-500">
                                        목표일: {new Date(savingsGoal.deadline).toLocaleDateString("ko-KR")}
                                    </p>
                                </div>
                                <div className="space-y-2">
                                    <div className="flex justify-between text-sm">
                                        <span>현재 저축액</span>
                                        <span>
                                            ₩{currentSavings.toLocaleString()} / ₩{savingsGoal.target.toLocaleString()}
                                        </span>
                                    </div>
                                    <Progress value={progress} className="h-2" />
                                    <p className="text-sm text-gray-500">
                                        {progress.toFixed(1)}% 달성
                                        {currentSavings >= savingsGoal.target && (
                                            <span className="text-green-600 font-medium ml-2">목표 달성!</span>
                                        )}
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <p className="text-gray-500">저축 목표를 설정해보세요.</p>
                        )}
                    </CardContent>

                    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
                        <DialogContent>
                            <DialogHeader>
                                <DialogTitle>저축 목표 설정</DialogTitle>
                            </DialogHeader>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <Label htmlFor="goalName">목표 이름</Label>
                                    <Input
                                        id="goalName"
                                        value={formData.name}
                                        onChange={(e) => setFormData((prev) => ({ ...prev, name: e.target.value }))}
                                        placeholder="예: 새 차 구매"
                                        required
                                    />
                                </div>
                                <div>
                                    <Label htmlFor="targetAmount">목표 금액</Label>
                                    <Input
                                        id="targetAmount"
                                        type="text"
                                        value={formData.target ? formatNumber(formData.target) : ''}
                                        onChange={(e) => {
                                            const numValue = parseFormattedNumber(e.target.value);
                                            setFormData((prev) => ({ ...prev, target: numValue }));
                                        }}
                                        placeholder="0"
                                        required
                                    />
                                </div>
                                <div>
                                    <Label htmlFor="deadline">목표 날짜</Label>
                                    <Input
                                        id="deadline"
                                        type="date"
                                        value={formData.deadline}
                                        onChange={(e) => setFormData((prev) => ({ ...prev, deadline: e.target.value }))}
                                        required
                                    />
                                </div>
                                <div className="flex justify-end gap-2">
                                    <Button type="button" variant="outline" onClick={() => setIsDialogOpen(false)}>
                                        취소
                                    </Button>
                                    <Button type="submit">저장</Button>
                                </div>
                            </form>
                        </DialogContent>
                    </Dialog>
                </Card>
            );
        }

        // Transaction Form Component
        function TransactionForm({ transaction, onSubmit, onCancel }) {
            const [formData, setFormData] = useState({
                type: transaction?.type || "expense",
                category: transaction?.category || "select",
                name: transaction?.name || "",
                amount: transaction?.amount || 0,
                currency: transaction?.currency || "KRW",
                datetime: transaction?.datetime || new Date().toISOString().slice(0, 16),
                tags: transaction?.tags?.join(", ") || "",
                memo: transaction?.memo || "",
            });

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function parseFormattedNumber(str) {
            return parseInt(str.replace(/,/g, '')) || 0;
        }

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.category === "select") {
                    return; // 카테고리가 선택되지 않았으면 제출하지 않음
                }
                onSubmit({
                    ...formData,
                    tags: formData.tags
                        .split(",")
                        .map((tag) => tag.trim())
                        .filter(Boolean),
                });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="type">유형</Label>
                            <Select
                                value={formData.type}
                                onValueChange={(value) =>
                                    setFormData((prev) => ({ ...prev, type: value, category: "" }))
                                }
                            >
                                <SelectItem value="income">수입</SelectItem>
                                <SelectItem value="expense">지출</SelectItem>
                            </Select>
                        </div>
                        <div>
                            <Label htmlFor="category">카테고리</Label>
                            <Select
                                value={formData.category}
                                onValueChange={(value) => setFormData((prev) => ({ ...prev, category: value }))}
                            >
                                <SelectItem value="select">카테고리 선택</SelectItem>
                                {CATEGORIES[formData.type].map((category) => (
                                    <SelectItem key={category} value={category}>
                                        {category}
                                    </SelectItem>
                                ))}
                            </Select>
                        </div>
                    </div>

                    <div>
                        <Label htmlFor="name">내용</Label>
                        <Input
                            id="name"
                            value={formData.name}
                            onChange={(e) => setFormData((prev) => ({ ...prev, name: e.target.value }))}
                            placeholder="거래 내용을 입력하세요"
                            required
                        />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="amount">금액</Label>
                            <Input
                                id="amount"
                                type="text"
                                value={formData.amount ? formatNumber(formData.amount) : ''}
                                onChange={(e) => {
                                    const numValue = parseFormattedNumber(e.target.value);
                                    setFormData((prev) => ({ ...prev, amount: numValue }));
                                }}
                                placeholder="0"
                                required
                            />
                        </div>
                        <div>
                            <Label htmlFor="currency">통화</Label>
                            <Select
                                value={formData.currency}
                                onValueChange={(value) => setFormData((prev) => ({ ...prev, currency: value }))}
                            >
                                {CURRENCIES.map((currency) => (
                                    <SelectItem key={currency.value} value={currency.value}>
                                        {currency.label}
                                    </SelectItem>
                                ))}
                            </Select>
                        </div>
                    </div>

                    <div>
                        <Label htmlFor="datetime">날짜 및 시간</Label>
                        <Input
                            id="datetime"
                            type="datetime-local"
                            value={formData.datetime}
                            onChange={(e) => setFormData((prev) => ({ ...prev, datetime: e.target.value }))}
                            required
                        />
                    </div>

                    <div>
                        <Label htmlFor="tags">태그 (쉼표로 구분)</Label>
                        <Input
                            id="tags"
                            value={formData.tags}
                            onChange={(e) => setFormData((prev) => ({ ...prev, tags: e.target.value }))}
                            placeholder="태그1, 태그2, 태그3"
                        />
                    </div>

                    <div>
                        <Label htmlFor="memo">메모</Label>
                        <Textarea
                            id="memo"
                            value={formData.memo}
                            onChange={(e) => setFormData((prev) => ({ ...prev, memo: e.target.value }))}
                            placeholder="추가 메모를 입력하세요"
                        />
                    </div>

                    <div className="flex justify-end gap-2">
                        <Button type="button" variant="outline" onClick={onCancel}>
                            취소
                        </Button>
                        <Button type="submit">{transaction ? "수정" : "추가"}</Button>
                    </div>
                </form>
            );
        }

        // Budget Management Component
        function BudgetManagement({ budgets, setBudgets, transactions }) {
            const [newBudget, setNewBudget] = useState({ category: "select", amount: 0 });

            const addBudget = () => {
                if (newBudget.category && newBudget.category !== "select" && newBudget.amount > 0) {
                    const spent = transactions
                        .filter((t) => t.type === "expense" && t.category === newBudget.category)
                        .reduce((sum, t) => sum + t.amount, 0);

                    setBudgets([
                        ...budgets.filter((b) => b.category !== newBudget.category),
                        {
                            ...newBudget,
                            spent,
                        },
                    ]);
                    setNewBudget({ category: "select", amount: 0 });
                }
            };

            const removeBudget = (category) => {
                setBudgets(budgets.filter((b) => b.category !== category));
            };

            return (
                <div className="space-y-6">
                    <Card>
                        <CardHeader>
                            <CardTitle>예산 설정</CardTitle>
                            <p className="text-sm text-gray-500">카테고리별 예산을 설정하고 관리하세요.</p>
                        </CardHeader>
                        <CardContent>
                            <div className="flex flex-col md:flex-row gap-2">
                                <Select
                                    value={newBudget.category}
                                    onValueChange={(value) => setNewBudget((prev) => ({ ...prev, category: value }))}
                                    className="flex-1"
                                >
                                    <SelectItem value="select">카테고리 선택</SelectItem>
                                    {CATEGORIES.expense.map((category) => (
                                        <SelectItem key={category} value={category}>
                                            {category}
                                        </SelectItem>
                                    ))}
                                </Select>
                                <Input
                                    type="text"
                                    placeholder="예산 금액"
                                    value={newBudget.amount ? formatNumber(newBudget.amount) : ''}
                                    onChange={(e) => {
                                        const numValue = parseFormattedNumber(e.target.value);
                                        setNewBudget((prev) => ({ ...prev, amount: numValue }));
                                    }}
                                    className="flex-1"
                                />
                                <Button onClick={addBudget}>추가</Button>
                            </div>
                        </CardContent>
                    </Card>

                    <div className="grid gap-4">
                        {budgets.map((budget) => {
                            const percentage = budget.amount > 0 ? (budget.spent / budget.amount) * 100 : 0;
                            const isOverBudget = percentage > 100;

                            return (
                                <Card key={budget.category}>
                                    <CardContent className="pt-6">
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className="font-semibold">{budget.category}</h3>
                                            <Button variant="ghost" size="sm" onClick={() => removeBudget(budget.category)}>
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                        </div>
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-sm">
                                                <span>
                                                    ₩{budget.spent.toLocaleString()} / ₩{budget.amount.toLocaleString()}
                                                </span>
                                                <span className={isOverBudget ? "text-red-600" : "text-gray-500"}>
                                                    {percentage.toFixed(1)}%
                                                </span>
                                            </div>
                                            <Progress value={Math.min(percentage, 100)} className={`h-2 ${isOverBudget ? "bg-red-100" : ""}`} />
                                            {isOverBudget && (
                                                <p className="text-sm text-red-600">
                                                    예산을 ₩{(budget.spent - budget.amount).toLocaleString()} 초과했습니다.
                                                </p>
                                            )}
                                        </div>
                                    </CardContent>
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Main App Component
        function BudgetApp() {
            const [transactions, setTransactions] = useState([]);
            const [budgets, setBudgets] = useState([]);
            const [savingsGoal, setSavingsGoal] = useState(null);
            const [activeTab, setActiveTab] = useState("overview");
            const [isDialogOpen, setIsDialogOpen] = useState(false);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [filterCategory, setFilterCategory] = useState("all");
            const [isDarkMode, setIsDarkMode] = useState(false);
            const { toast, toasts } = useToast();

            // Load data from localStorage on mount
            useEffect(() => {
                const savedData = localStorage.getItem("budgetAppData");
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        setTransactions(data.transactions || []);
                        setBudgets(data.budgets || []);
                        setSavingsGoal(data.savingsGoal || null);
                        setIsDarkMode(data.isDarkMode || false);
                    } catch (error) {
                        console.error("Failed to load data:", error);
                    }
                }
            }, []);

            // Save data to localStorage whenever state changes
            useEffect(() => {
                const data = {
                    transactions,
                    budgets,
                    savingsGoal,
                    isDarkMode,
                };
                localStorage.setItem("budgetAppData", JSON.stringify(data));
            }, [transactions, budgets, savingsGoal, isDarkMode]);

            // Apply dark mode
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
            }, [isDarkMode]);

            const addTransaction = (transaction) => {
                const newTransaction = {
                    ...transaction,
                    id: Date.now().toString(),
                };
                setTransactions((prev) => [...prev, newTransaction]);

                // Update budget spending
                if (transaction.type === "expense") {
                    setBudgets((prev) =>
                        prev.map((budget) =>
                            budget.category === transaction.category 
                                ? { ...budget, spent: budget.spent + transaction.amount } 
                                : budget
                        )
                    );
                }

                toast({
                    title: "거래 추가됨",
                    description: `${transaction.type === "income" ? "수입" : "지출"} ${transaction.amount.toLocaleString()}원이 추가되었습니다.`,
                });
            };

            const updateTransaction = (updatedTransaction) => {
                setTransactions((prev) => prev.map((t) => (t.id === updatedTransaction.id ? updatedTransaction : t)));
                toast({
                    title: "거래 수정됨",
                    description: "거래 내역이 성공적으로 수정되었습니다.",
                });
            };

            const deleteTransaction = (id) => {
                const transaction = transactions.find((t) => t.id === id);
                if (transaction) {
                    setTransactions((prev) => prev.filter((t) => t.id !== id));

                    // Update budget spending
                    if (transaction.type === "expense") {
                        setBudgets((prev) =>
                            prev.map((budget) =>
                                budget.category === transaction.category
                                    ? { ...budget, spent: Math.max(0, budget.spent - transaction.amount) }
                                    : budget
                            )
                        );
                    }

                    toast({
                        title: "거래 삭제됨",
                        description: "거래 내역이 삭제되었습니다.",
                    });
                }
            };

            const exportData = () => {
                const data = { transactions, budgets, savingsGoal };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `budget-data-${new Date().toISOString().split("T")[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                toast({
                    title: "데이터 내보내기 완료",
                    description: "데이터가 성공적으로 내보내졌습니다.",
                });
            };

            const importData = (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target?.result);
                        if (data.transactions) {
                            setTransactions(data.transactions);
                            setBudgets(data.budgets || []);
                            setSavingsGoal(data.savingsGoal || null);
                            toast({
                                title: "데이터 가져오기 완료",
                                description: "데이터가 성공적으로 가져와졌습니다.",
                            });
                        }
                    } catch (error) {
                        toast({
                            title: "오류",
                            description: "올바른 데이터 파일이 아닙니다.",
                            variant: "destructive",
                        });
                    }
                };
                reader.readAsText(file);
                event.target.value = "";
            };

            const totalIncome = transactions.filter((t) => t.type === "income").reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter((t) => t.type === "expense").reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;

            return (
                <div className="min-h-screen bg-background">
                    <header className="border-b bg-card">
                        <div className="container mx-auto px-4 py-4">
                            <div className="flex items-center justify-between flex-col md:flex-row gap-4">
                                <div className="flex items-center gap-2">
                                    <Wallet className="h-8 w-8 text-primary" />
                                    <h1 className="text-2xl font-bold">스마트 가계부</h1>
                                </div>
                                <div className="flex items-center gap-2 flex-wrap">
                                    <Button variant="outline" size="sm" onClick={() => setIsDarkMode(!isDarkMode)}>
                                        {isDarkMode ? <Sun className="h-4 w-4" /> : <Moon className="h-4 w-4" />}
                                    </Button>
                                    <Button variant="outline" size="sm" onClick={exportData}>
                                        <Download className="h-4 w-4 mr-2" />
                                        내보내기
                                    </Button>
                                    <Button variant="outline" size="sm">
                                        <label className="flex items-center cursor-pointer">
                                            <Upload className="h-4 w-4 mr-2" />
                                            가져오기
                                            <input type="file" accept=".json" className="hidden" onChange={importData} />
                                        </label>
                                    </Button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto px-4 py-6">
                        <Tabs value={activeTab} onValueChange={setActiveTab}>
                            <TabsList>
                                <TabsTrigger value="overview">개요</TabsTrigger>
                                <TabsTrigger value="transactions">거래내역</TabsTrigger>
                                <TabsTrigger value="budget">예산관리</TabsTrigger>
                                <TabsTrigger value="calendar">캘린더</TabsTrigger>
                                <TabsTrigger value="analytics">분석</TabsTrigger>
                            </TabsList>

                            <TabsContent value="overview">
                                <div className="space-y-6">
                                    <div className="grid gap-4 md:grid-cols-3">
                                        <Card>
                                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                                <CardTitle className="text-sm font-medium">총 수입</CardTitle>
                                                <TrendingUp className="h-4 w-4 text-green-600" />
                                            </CardHeader>
                                            <CardContent>
                                                <div className="text-2xl font-bold text-green-600">₩{totalIncome.toLocaleString()}</div>
                                            </CardContent>
                                        </Card>
                                        <Card>
                                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                                <CardTitle className="text-sm font-medium">총 지출</CardTitle>
                                                <TrendingDown className="h-4 w-4 text-red-600" />
                                            </CardHeader>
                                            <CardContent>
                                                <div className="text-2xl font-bold text-red-600">₩{totalExpense.toLocaleString()}</div>
                                            </CardContent>
                                        </Card>
                                        <Card>
                                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                                <CardTitle className="text-sm font-medium">잔액</CardTitle>
                                                <Wallet className="h-4 w-4 text-blue-600" />
                                            </CardHeader>
                                            <CardContent>
                                                <div className={`text-2xl font-bold ${balance >= 0 ? "text-green-600" : "text-red-600"}`}>
                                                    ₩{balance.toLocaleString()}
                                                </div>
                                            </CardContent>
                                        </Card>
                                    </div>

                                    <div className="grid gap-6 md:grid-cols-2">
                                        <BudgetOverview budgets={budgets} />
                                        <SavingsGoal savingsGoal={savingsGoal} setSavingsGoal={setSavingsGoal} currentSavings={balance} />
                                    </div>
                                </div>
                            </TabsContent>

                            <TabsContent value="transactions">
                                <div className="space-y-6">
                                    <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                        <div className="flex flex-col md:flex-row gap-2">
                                            <div className="relative">
                                                <Search className="absolute left-2 top-2.5 h-4 w-4 text-gray-500" />
                                                <Input
                                                    placeholder="거래 검색..."
                                                    value={searchTerm}
                                                    onChange={(e) => setSearchTerm(e.target.value)}
                                                    className="pl-8"
                                                />
                                            </div>
                                            <Select value={filterCategory} onValueChange={setFilterCategory} className="w-full md:w-48">
                                                <SelectItem value="all">모든 카테고리</SelectItem>
                                                {[...CATEGORIES.income, ...CATEGORIES.expense].map((category) => (
                                                    <SelectItem key={category} value={category}>
                                                        {category}
                                                    </SelectItem>
                                                ))}
                                            </Select>
                                        </div>
                                        <Button onClick={() => {
                                            setEditingTransaction(null);
                                            setIsDialogOpen(true);
                                        }}>
                                            <PlusCircle className="h-4 w-4 mr-2" />
                                            거래 추가
                                        </Button>
                                    </div>

                                    <TransactionList
                                        transactions={transactions}
                                        searchTerm={searchTerm}
                                        filterCategory={filterCategory}
                                        onEdit={(transaction) => {
                                            setEditingTransaction(transaction);
                                            setIsDialogOpen(true);
                                        }}
                                        onDelete={deleteTransaction}
                                    />
                                </div>
                            </TabsContent>

                            <TabsContent value="budget">
                                <BudgetManagement budgets={budgets} setBudgets={setBudgets} transactions={transactions} />
                            </TabsContent>

                            <TabsContent value="calendar">
                                <CalendarView transactions={transactions} />
                            </TabsContent>

                            <TabsContent value="analytics">
                                <ExpenseChart transactions={transactions} />
                            </TabsContent>
                        </Tabs>
                    </main>

                    <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
                        <DialogContent>
                            <DialogHeader>
                                <DialogTitle>{editingTransaction ? "거래 수정" : "새 거래 추가"}</DialogTitle>
                                <p className="text-sm text-gray-500">
                                    {editingTransaction ? "거래 정보를 수정하세요." : "새로운 수입 또는 지출을 추가하세요."}
                                </p>
                            </DialogHeader>
                            <TransactionForm
                                transaction={editingTransaction}
                                onSubmit={(transaction) => {
                                    if (editingTransaction) {
                                        updateTransaction({ ...transaction, id: editingTransaction.id });
                                    } else {
                                        addTransaction(transaction);
                                    }
                                    setIsDialogOpen(false);
                                    setEditingTransaction(null);
                                }}
                                onCancel={() => {
                                    setIsDialogOpen(false);
                                    setEditingTransaction(null);
                                }}
                            />
                        </DialogContent>
                    </Dialog>

                    <Toast toasts={toasts} />
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<BudgetApp />, document.getElementById('root'));
    </script>
</body>
</html>
